<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Homepage</title>
    <link rel="stylesheet" href="/admin/home/styles.css">
</head>

<body>
    <div id="topContainer">
        <button onclick="opennotifications()" class="blank-button">
            <img class="top-img" src="/resources/notification-bell.svg" alt="Notification">
        </button>
        <dialog id="notificationdialog">
            <h1>Notifications:</h1>
            <div id="notifdiv"></div>
            <button onclick="closenotifications()">Close</button>
        </dialog>
        <button class="blank-button">
            <img class="top-img" src="/resources/messages-icon.svg" alt="Notification">
        </button>
        <button id="createNewBtn">Create New User</button>
        <div id="rightdiv">
            <button id="logOutBtn">Log Out</button>
            <h1 id="username"></h1>
        </div>
    </div>
    <div id="bottomContainer"></div>
    <div id="requestscontainer">
        <h1 id="requestsheader">Requests:</h1>
    </div>
    
</body>

<script>
    const requestscontainer = document.getElementById("requestscontainer")
    const bottomContainer = document.getElementById("bottomContainer")

    const username = document.getElementById("username")
    username.innerHTML = window.localStorage.getItem("firstname") + " " + window.localStorage.getItem("lastname")

    const createNewBtn = document.getElementById("createNewBtn")
    createNewBtn.onclick = function() {
        window.location.replace("/admin/createaccount")
    }

    //Define the click event of the logout button to send a request to the server to delete the login cookie of the current user then go back to the login page
    const logoutbtn = document.getElementById("logOutBtn")
    logoutbtn.onclick = function() {
        fetch("/api/logout", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )}
        }).then(res => {
            window.localStorage.clear("firstname")
            window.localStorage.clear("lastname")
            window.localStorage.clear("logincookie")
            window.location.replace("/login")
        })
    }

    //Sends a request to the server to set the accepted value of the request to true
    function accept(id) {
        fetch("/api/admin/acceptrequest", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                requestid: id
            })
        }).then(() => {
            location.reload()
        })
        
    }

    //Sends a request to the server to delete the request
    function decline(id) {
        fetch("/api/admin/deleterequest", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                requestid: id
            })
        }).then(() => {
            location.reload()
        })
    }

    function viewstats(firstname, lastname) {
        //todooooo
        console.log(`${firstname} ${lastname}`)
    }

    //Reset the users password to "password"
    function resetpass(firstname, lastname) {
        fetch("/api/admin/resetpassword", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                firstname: firstname,
                lastname: lastname
            })
        }).then(() => {
            alert("Password reset to \"password\"")
        })
    }

    function removeuser(firstname, lastname) {
        fetch("/api/admin/removeuser", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                firstname: firstname,
                lastname: lastname
            })
        }).then(() => {
            location.reload()
        })
    }

    
    async function opennotifications() {
        //Get all notifications from the server
        const res = await fetch("/api/getnotifications", {
            method: "GET",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )}
        })
        //Set the contents of the notification dialog to include all notifications sent by the server, with a circle next to unread ones
        notifdiv.innerHTML = ""
        const notifs = await res.json()
        for (notif of notifs) {
            const div = document.createElement("div")
            let unreadcircle
            if (notif[2] == 0) {
                unreadcircle = document.createElement("h1")
                unreadcircle.id = String(notif[3]) + "_unreadcircleref"
                unreadcircle.innerHTML = "&#9673&nbsp"
                div.appendChild(unreadcircle)
                div.addEventListener("mouseenter", function() {
                    //If the user mouses over an unread notification then delete the circle and send a request to the server to mark it as read
                    const circle = document.getElementById(String(notif[3]) + "_unreadcircleref")
                    if (circle) {
                        circle.remove()
                        fetch("/api/readnotification", {
                            method: "POST",
                            headers: {
                                authorization: JSON.stringify({
                                    FirstName: window.localStorage.getItem("firstname"),
                                    LastName: window.localStorage.getItem("lastname"),
                                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                                }
                            )},
                            body: JSON.stringify({notifid: notif[3]})
                        })
                    }
                })
            }
            div.innerHTML += `
                <h1>${notif[0]}&nbsp&nbsp</h1>
                <h1>${notif[1]}</h1>
            `
            notifdiv.appendChild(div)
        }
        notificationdialog.showModal()
    }

    function closenotifications() {
        notificationdialog.close()
    }

    async function main() {
        //Gets all requests for users managed by the current logged in user
        const requests = await (await fetch("/api/admin/getrequests", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            }
        })).json()

        //For each request, adds an entry to the requests div
        for (req of requests) {
            const div = document.createElement("div")
            div.classList.add("requestdiv")
            requestscontainer.appendChild(div)
            div.innerHTML = `
                <h1>${req[3]} ${req[4]} - ${["Overtime", "Leave"][req[0]]} - ${new Date(req[1]).toLocaleString()} for ${String(Math.floor(req[2]/3600000)).padStart(2,'0')}:${String(Math.floor(req[2]/60000)%60).padStart(2,'0')}</h1>
                <button onclick="accept(${req[5]})" class="acceptbutton">Accept</button>
                <button onclick="decline(${req[5]})" class="acceptbutton">Decline</button>
            `
        }

        //Gets all users managed by the current logged in user
        const managedRes = await fetch("/api/admin/getmanaged", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            }
        })
        const managed = await managedRes.json()

        //For all employees, adds an entry to the users div
        for (employee of managed) {
            const div = document.createElement("div")
            div.classList.add("employeeDiv")
            const name = document.createElement("h1")
            name.innerHTML = employee[0] + " " + employee[1]
            div.appendChild(name)
            const btnsdiv = document.createElement("div")
            btnsdiv.innerHTML = `
                <button class="employeebtns" onclick="viewstats('${employee[0]}', '${employee[1]}')">View Stats</button>
                <button class="employeebtns" onclick="resetpass('${employee[0]}', '${employee[1]}')">Reset Password</button>
                <button class="employeebtns" onclick="removeuser('${employee[0]}', '${employee[1]}')">Remove User</button>
            `
            btnsdiv.classList.add("btnsdiv")
            div.appendChild(btnsdiv)
            bottomContainer.appendChild(div)
        }
    }
    main()
</script>

</html>