<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link rel="stylesheet" href="/messages/styles.css">
</head>
<body>
    <dialog id="addpersonmodal">
        <label for="personselect">Add:</label>
        <select id="personselect"></select>
        <button onclick="addPerson()">Ok</button>
    </dialog>
    <div id="topbar">
        <button onclick="back()" id="backbutton">
            <img id="backimg" class="top-img" src="/resources/back-button.svg" alt="Back To Homepage">
        </button>
        <h1 id="username"></h1>
    </div>
    <div id="container">
        <div id="leftcontainer">
            <div id="people"></div>
            <button onclick="openAddPersonDialog()" id="addperson">Send New Message</button>
        </div>
        <div id="rightcontainer">
            <div id="messages"></div>
            <div id="inputcontainer">
                <input type="text" name="msginput" id="msginput">
                <button id="sendbtn">Send</button>
            </div>
        </div>
    </div>
</body>

<script>
    const peoplecontainer = document.getElementById("people")
    const msgcontainer = document.getElementById("messages")

    const msginput = document.getElementById("msginput")

    const addpersonmodal = document.getElementById("addpersonmodal")
    const personselect = document.getElementById("personselect")

    document.getElementById("username").innerHTML = window.localStorage.getItem("firstname") + " " + window.localStorage.getItem("lastname")

    let messagepeople = []

    function back() {
        window.location.replace("/")
    }

    fetch("/api/getmessagepeople", {
        method: "GET",
        headers: {
            authorization: JSON.stringify({
                FirstName: window.localStorage.getItem("firstname"),
                LastName: window.localStorage.getItem("lastname"),
                LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
            }
        )},
    }).then(res => res.json()).then(people => {
        messagepeople = people
        people.forEach(i => {
            const div = document.createElement("div")
            div.classList.add("persondiv")
            div.innerHTML = `
                <h1>${i[0]} ${i[1]}</h1>
            `
            div.firstname = i[0]
            div.lastname = i[1]
            peoplecontainer.appendChild(div)    
            div.addEventListener("click", () => {
                setMessagePerson(i[0], i[1])
            })
        })
    })

    let currentPerson = null

    setInterval(() => {
        if (!currentPerson) return
        setMessagePerson(currentPerson[0], currentPerson[1])
    }, 1000)

    function setMessagePerson(firstname, lastname) {
        currentPerson = [firstname, lastname]
        fetch("/api/getmessages", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )},
            body: JSON.stringify({
                firstname: firstname,
                lastname: lastname
            })
        }).then(res => res.json()).then(msgs => {
            msgcontainer.innerHTML = ""
            msgs.forEach(msg => {
                const div = document.createElement("div")
                div.innerHTML = `
                    <h1 class="${msg[2] == 1 ? "mymsg" : "theirmsg"}">${msg[0]}</h1>
                `
                msgcontainer.appendChild(div)
                msgcontainer.scrollTop = msgcontainer.scrollHeight
            })
        })
    }

    async function openAddPersonDialog() {
        let res = await fetch("/api/getpeople", {
            method: "GET",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )}
        })
        let newpeople = await res.json()
        console.log(newpeople)
        console.log(messagepeople)

        for (person of newpeople) {
            alreadyExists = false
            for (existing of messagepeople) {
                if (JSON.stringify(person) == JSON.stringify(existing) || ) {
                    alreadyExists = true
                    break
                }
            }
            if (!alreadyExists) {
                const option = document.createElement("option")
                option.value = JSON.stringify(person)
                option.innerHTML = person.join(" ")
                personselect.appendChild(option)
            }
        }

        addpersonmodal.showModal()
    }

    async function addPerson() {
        addpersonmodal.close()
        let person = JSON.parse(personselect.value)

        //Add the person to the list
        const div = document.createElement("div")
        div.classList.add("persondiv")
        div.innerHTML = `
            <h1>${person[0]} ${person[1]}</h1>
        `
        div.firstname = person[0]
        div.lastname = person[1]
        peoplecontainer.appendChild(div)    
        div.addEventListener("click", () => {
            setMessagePerson(person[0], person[1])
        })
    }

    document.getElementById("sendbtn").onclick = function() {
        if (currentPerson == null) return
        if (msginput.value == "") return
        const msg = msginput.value
        fetch("/api/sendmessage", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )},
            body: JSON.stringify({
                firstname: currentPerson[0],
                lastname: currentPerson[1],
                msg: msg
            })
        }).then(res => {
            const div = document.createElement("div")
            div.innerHTML = `
                <h1 class="mymsg">${msg}</h1>
            `
            msgcontainer.appendChild(div)
            msgcontainer.scrollTop = msgcontainer.scrollHeight
            msginput.value = ""
        })
    }
</script>

</html>