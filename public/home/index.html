<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <link rel="stylesheet" href="/home/styles.css">
</head>

<body>
    <div id="topcontainer">
        <button onclick="opennotifications()" class="blank-button">
            <img class="top-img" src="/resources/notification-bell.svg" alt="Notification">
        </button>
        <dialog id="notificationdialog">
            <h1>Notifications:</h1>
            <div id="notifdiv"></div>
            <button onclick="closenotifications()">Close</button>
        </dialog>
        <button class="blank-button">
            <img class="top-img" src="/resources/messages-icon.svg" alt="Notification">
        </button>
        <h1 id="username" class="pushright"></h1>
    </div>
    <div id="midcontainer">
        <div class="pushright">
            <button onclick="changepassword()" id="passbtn">Change Password</button>
            <button id="logoutbtn" onclick="logout()">Log Out</button>
        </div>
    </div>
    <div id="bottomcontainer">
        <div id="leftcontainer">
            <div id="requestscontainer">
                <div id="requesttypecontainer">
                    <input id="overtime" type="radio" name="requesttype">
                    <label id="overtimelabel" for="overtime">Overtime</label>
                    <input id="leave" type="radio" name="requesttype">
                    <label id="leavelabel" for="leave">Leave</label>
                </div>
                <div id="requesttimecontainer">
                    <label for="requestdate">Date</label>
                    <input type="date" name="requestdate" id="requestdate">
                    <label for="requesttime">Time</label>
                    <input type="time" name="requesttime" id="requesttime">
                </div>
                <div id="requestlengthcontainer">
                    <label for="requestlength">Length</label>
                    <input type="time" name="requestlength" id="requestlength">
                </div>
                <button id="submitbtn" onclick="submit()">Submit</button>
            </div>
            <div id="clockincontainer">
                <button id="clockinbtn" onclick="clockstatus(1)">Clock In</button>
                <button id="clockoutbtn" onclick="clockstatus(0)">Clock Out</button>
            </div>
        </div>
        <div id="rightcontainer">
            <canvas id="timetablecanvas" width="1000" height="1000"></canvas>
        </div>
    </div>
</body>

<script>
    const username = document.getElementById("username")
    username.innerHTML = window.localStorage.getItem("firstname") + " " + window.localStorage.getItem("lastname")

    const overtime = document.getElementById("overtime")
    const leave = document.getElementById("leave")

    const date = document.getElementById("requestdate")
    const time = document.getElementById("requesttime")
    const length = document.getElementById("requestlength")

    const clockinbtn = document.getElementById("clockinbtn")
    const clockoutbtn = document.getElementById("clockoutbtn")

    const notificationdialog = document.getElementById("notificationdialog")
    const notifdiv = document.getElementById("notifdiv")

    //Sends a request to the server to see if the user is clocked in or out and colour the buttons accordingly
    fetch("/api/getclockstatus", {
        headers: {
            authorization: JSON.stringify({
                FirstName: window.localStorage.getItem("firstname"),
                LastName: window.localStorage.getItem("lastname"),
                LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
            }
        )}
    }).then(res => res.json()).then(json => {
        if (json.status == 0) {
            clockinbtn.style.backgroundColor = "green"
            clockoutbtn.style.backgroundColor = "red"
        } else if (json.status == 1) {
            clockinbtn.style.backgroundColor = "red"
            clockoutbtn.style.backgroundColor = "green"
        }
    })

    //Creates a canvas for the timetable
    const canvas = document.getElementById("timetablecanvas")
    const ctx = canvas.getContext("2d")

    const now = new Date()
    now.setDate(now.getDate() - ((now.getDay()+6) % 7))
    const weekbeginning = now.getDate() + " " + now.toLocaleString('en-GB', { month: 'long' })
    const weekbeginningtime = new Date(new Date().setDate(new Date().getDate() - ((new Date().getDay() + 6) % 7))).setHours(0,0,0,0) - (new Date().getTimezoneOffset()*60000)

    console.log(weekbeginningtime)

    //Adds week beginning text
    ctx.strokeRect(150,150,700,700)
    ctx.font = "50px Arial"
    ctx.textAlign = "center"
    ctx.fillText(`Week beginning ${weekbeginning}`,500,80)

    //Draw lines to separate days
    for (let i = 250; i < 850; i += 100) {
        ctx.moveTo(i, 150)
        ctx.lineTo(i, 850)
        ctx.stroke()
    }

    //Add times down the left side
    ctx.font = "20px Arial"
    ctx.textAlign = "right"
    ctx.textBaseline = "middle"
    for (let i = 0; i <= 24; i += 3) {
        ctx.fillText(`${i}:00`, 130, 150+(i*(700/24)))
    }

    //Gets the users timetable for the week, then creates rectangles in the canvas to represent them
    fetch("/api/gettimetable", {
        method: "GET",
        headers: {
            authorization: JSON.stringify({
                FirstName: window.localStorage.getItem("firstname"),
                LastName: window.localStorage.getItem("lastname"),
                LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
            }
        )}
    }).then(res => res.json()).then(json => {
        console.log(json)
        for (event of json) {
            //For each block to be placed calculate its position on the canvas
            const startoffsetms = event[1] - weekbeginningtime
            const day = Math.ceil(startoffsetms / 86400000)
            const through = (startoffsetms % 86400000) / 86400000
            if (event[0] == 0) {
                ctx.fillStyle = "blue"
            } else if (event[0] == 1) {
                ctx.fillStyle = "red"
            }
            ctx.fillRect(150 + (day * 100), 150 + (through * 700), 100, event[2]*0.00000810185)
        }
    })

    async function opennotifications() {
        //Get all notifications from the server
        const res = await fetch("/api/getnotifications", {
            method: "GET",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )}
        })
        //Set the contents of the notification dialog to include all notifications sent by the server, with a circle next to unread ones
        notifdiv.innerHTML = ""
        const notifs = await res.json()
        for (notif of notifs) {
            const div = document.createElement("div")
            let unreadcircle
            if (notif[2] == 0) {
                unreadcircle = document.createElement("h1")
                unreadcircle.id = String(notif[3]) + "_unreadcircleref"
                unreadcircle.innerHTML = "&#9673&nbsp"
                div.appendChild(unreadcircle)
                div.addEventListener("mouseenter", function() {
                    //If the user mouses over an unread notification then delete the circle and send a request to the server to mark it as read
                    const circle = document.getElementById(String(notif[3]) + "_unreadcircleref")
                    if (circle) {
                        circle.remove()
                        fetch("/api/readnotification", {
                            method: "POST",
                            headers: {
                                authorization: JSON.stringify({
                                    FirstName: window.localStorage.getItem("firstname"),
                                    LastName: window.localStorage.getItem("lastname"),
                                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                                }
                            )},
                            body: JSON.stringify({notifid: notif[3]})
                        })
                    }
                })
            }
            div.innerHTML += `
                <h1>${notif[0]}&nbsp&nbsp</h1>
                <h1>${notif[1]}</h1>
            `
            notifdiv.appendChild(div)
        }
        notificationdialog.showModal()
    }

    function closenotifications() {
        notificationdialog.close()
    }

    //Sends a request to the server to delete the users login cookie then goes back to the login page
    function logout() {
        fetch("/api/logout", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                }
            )}
        }).then(res => {
            window.localStorage.clear("firstname")
            window.localStorage.clear("lastname")
            window.localStorage.clear("logincookie")
            window.location.replace("/login")
        })
    }

    //Gets the data from inputs and sends the request to the server where it is inserted into the database
    function submit() {
        if (leave.checked == overtime.checked) {
            window.alert("Select a type of request!")
            return
        }
        let requesttype = overtime.checked ? 0 : 1
        let timestamp = date.valueAsDate.getTime() + time.valueAsNumber

        let temptime = length.value.split(":").map(Number)
        let lengthms = (3600000 * temptime[0]) + (60000 * temptime[1])

        fetch("/api/createrequest", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                requesttype: requesttype,
                timestamp: timestamp,
                length: lengthms
            })
        })
    }

    //Sends a request to the server to create an entry in the clock in table with the current status, and changes the colour of the buttons accordingly
    function clockstatus(status) {
        fetch("/api/setclockstatus", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({status: status})
        }).then(() => {
            if (status == 0) {
                clockinbtn.style.backgroundColor = "green"
                clockoutbtn.style.backgroundColor = "red"
            } else if (status == 1) {
                clockinbtn.style.backgroundColor = "red"
                clockoutbtn.style.backgroundColor = "green"
            }
        })
    }

    function changepassword() {
        let pass = window.prompt("Change password:")
        if (pass == "" || pass == null) return
        fetch("/api/changepassword", {
            method: "POST",
            headers: {
                authorization: JSON.stringify({
                    FirstName: window.localStorage.getItem("firstname"),
                    LastName: window.localStorage.getItem("lastname"),
                    LoginCookie: parseInt(window.localStorage.getItem("logincookie"))
                })
            },
            body: JSON.stringify({
                newpassword: pass
            })
        })
    }
</script>

</html>